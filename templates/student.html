{% extends "base.html" %}
{% block content %}
  <h1>👩‍🎓 Student Dashboard</h1>

  <!-- Login Form -->
  <h2>Login</h2>
  <form id="studentLogin">
    <label>ID: <input type="text" id="id" name="id" value="23aiml001" required></label><br>
    <label>Password: <input type="password" id="password" name="password" value="p001" required></label><br>
    <button type="submit">Login</button>
  </form>
  <pre id="loginResult"></pre>

  <!-- Marks by Date -->
  <div id="studentSection" style="display:none;">
    <h2>Check Marks by Date</h2>
    <form id="studentMarks">
      <label>Date (DD/MM/YYYY): <input type="text" name="date" required></label><br>
      <button type="submit">Get Marks</button>
    </form>
    <pre id="marksResult"></pre>

    <!-- Attendance History -->
    <h2>Attendance History</h2>
    <form id="studentAttendance">
      <button type="submit">Get Attendance</button>
    </form>
    <pre id="attResult"></pre>

    <!-- Logout -->
    <h2>Logout</h2>
    <form id="studentLogout">
      <button type="submit">Logout</button>
    </form>
    <pre id="logoutResult"></pre>
  </div>

  <script>
    let loggedIn = false;

    async function postJSON(url, data) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error("Server error: " + text);
      }
      return res.json();
    }

    // Login
    document.getElementById("studentLogin").addEventListener("submit", async e => {
      e.preventDefault();
      const id = document.getElementById("id").value;
      const password = document.getElementById("password").value;

      try {
        const res = await postJSON("/student/login", { id, password });
        document.getElementById("loginResult").textContent = JSON.stringify(res, null, 2);

        if (res.status === "success") {
          loggedIn = true;
          document.getElementById("studentSection").style.display = "block";
          alert("✅ Login successful!");
        } else {
          loggedIn = false;
          alert("❌ Invalid credentials");
        }
      } catch (err) {
        alert("⚠️ Error: " + err.message);
      }
    });

    // Marks
    document.getElementById("studentMarks").addEventListener("submit", async e => {
      e.preventDefault();
      if (!loggedIn) return alert("❌ Please login first");
      const date = e.target.date.value;
      const res = await postJSON("/student/marks_by_date", { date });
      document.getElementById("marksResult").textContent = JSON.stringify(res, null, 2);
    });

    // Attendance
    document.getElementById("studentAttendance").addEventListener("submit", async e => {
      e.preventDefault();
      if (!loggedIn) return alert("❌ Please login first");
      const res = await postJSON("/student/attendance_history", {});
      document.getElementById("attResult").textContent = JSON.stringify(res, null, 2);
    });

    // Logout
    document.getElementById("studentLogout").addEventListener("submit", async e => {
      e.preventDefault();
      const res = await fetch("/student/logout", { method: "POST" });
      document.getElementById("logoutResult").textContent = JSON.stringify(await res.json(), null, 2);
      loggedIn = false;
      document.getElementById("studentSection").style.display = "none";
      alert("👋 Logged out successfully.");
    });
  </script>
{% endblock %}
